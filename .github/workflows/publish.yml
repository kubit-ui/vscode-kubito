name: Auto Publish Extension

# This workflow automatically publishes the VS Code extension to the marketplace
# It runs when PRs are merged and analyzes the PR content to determine version bump
#
# Required secrets:
# 1. VSCE_PAT: Visual Studio Marketplace Personal Access Token
#    - Go to https://dev.azure.com/
#    - Create a Personal Access Token with "Marketplace > Manage" permissions
#
# 2. RELEASE_TOKEN: GitHub Personal Access Token for bypassing branch protection
#    - Go to github.com ‚Üí Settings ‚Üí Developer settings ‚Üí Personal access tokens
#    - Generate a "Classic" token with "repo" and "workflow" permissions
#    - OR use Fine-grained PAT with "Contents: write" and "Pull requests: write"

on:
  pull_request:
    types: [closed]
    branches:
      - cms

permissions:
  contents: write
  pull-requests: write
  packages: write
  actions: read

jobs:
  auto-publish:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    name: Auto Publish to VS Code Marketplace

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup display for tests
        run: |
          sudo apt-get update
          sudo apt-get install -y xvfb

      - name: Validate branch patterns
        id: validate-branch
        run: |
          BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
          echo "Branch name: $BRANCH_NAME"

          # Simplified pattern that properly handles hyphens, underscores, and dots
          if [[ "$BRANCH_NAME" =~ ^(feat|feature|fix|bugfix|break|breaking|hotfix|chore)/[a-zA-Z0-9._-]+$ ]]; then
            echo "Branch pattern accepted: $BRANCH_NAME"
            echo "should_publish=true" >> "$GITHUB_OUTPUT"
            echo "branch_name=$BRANCH_NAME" >> "$GITHUB_OUTPUT"
          else
            echo "Branch '$BRANCH_NAME' doesn't match required patterns"
            echo "should_publish=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install dependencies
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          echo "Installing dependencies with pnpm..."
          pnpm --version
          pnpm install --frozen-lockfile

      - name: Validate package.json
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          # Verify that package.json is well-formed
          EXTENSION_NAME=$(node -p "require('./package.json').name")
          PUBLISHER=$(node -p "require('./package.json').publisher")
          echo "Extension name: $EXTENSION_NAME"
          echo "Publisher: $PUBLISHER"

      - name: Configure Git
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          # Configure git with release token for branch protection bypass
          git config --local user.email "kubito-bot@github.com"
          git config --local user.name "Kubito Release Bot"

          # Set up authentication for push operations
          if [ -n "${{ secrets.RELEASE_TOKEN }}" ]; then
            echo "Using RELEASE_TOKEN with branch protection bypass permissions"
            git remote set-url origin https://x-access-token:${{ secrets.RELEASE_TOKEN }}@github.com/${{ github.repository }}.git
          else
            echo "Using default GITHUB_TOKEN - may fail on protected branches"
            echo "Add RELEASE_TOKEN secret with 'Contents: write' and 'Pull requests: write' permissions"
          fi

      - name: Detect version bump type from commits
        if: steps.validate-branch.outputs.should_publish == 'true'
        id: detect
        run: |
          BASE_REF="origin/${{ github.event.pull_request.base.ref }}"

          echo "üìù Analyzing commits in this PR..."

          # Get all commit messages in the PR
          COMMITS=$(git log --pretty=format:"%s" $BASE_REF..HEAD)
          echo "Commits:"
          echo "$COMMITS"
          echo ""

          # Detect version bump type from commits
          BUMP_TYPE="patch"
          HAS_FEAT=false
          HAS_BREAKING=false

          while IFS= read -r commit; do
            if [[ "$commit" =~ ^(break|breaking|feat!) ]] || [[ "$commit" =~ BREAKING\ CHANGE ]]; then
              HAS_BREAKING=true
            elif [[ "$commit" =~ ^feat ]]; then
              HAS_FEAT=true
            fi
          done <<< "$COMMITS"

          if [ "$HAS_BREAKING" = true ]; then
            BUMP_TYPE="major"
          elif [ "$HAS_FEAT" = true ]; then
            BUMP_TYPE="minor"
          fi

          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT
          echo "üì¶ Version bump type: $BUMP_TYPE"

      - name: Create changeset
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          BUMP_TYPE="${{ steps.detect.outputs.bump_type }}"
          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"

          # Clean PR title for changeset summary
          SUMMARY=$(echo "$PR_TITLE" | sed -E 's/^(feat|fix|docs|style|refactor|perf|test|chore|build|ci|break|breaking)(\([^)]+\))?!?:\s*//')

          # Create changeset file
          CHANGESET_ID=$(date +%s)
          CHANGESET_FILE=".changeset/auto-$CHANGESET_ID.md"

          echo "---" > $CHANGESET_FILE
          echo "\"vscode-kubito\": $BUMP_TYPE" >> $CHANGESET_FILE
          echo "---" >> $CHANGESET_FILE
          echo "" >> $CHANGESET_FILE
          echo "$SUMMARY" >> $CHANGESET_FILE
          echo "" >> $CHANGESET_FILE
          echo "PR: #$PR_NUMBER" >> $CHANGESET_FILE

          echo "‚úÖ Created changeset:"
          cat $CHANGESET_FILE

      - name: Run linting
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          pnpm run lint

      - name: Run tests (optional)
        if: steps.validate-branch.outputs.should_publish == 'true'
        continue-on-error: true
        run: |
          echo "Running tests with xvfb for headless environment..."
          xvfb-run -a pnpm run test || echo "Tests failed, but continuing with publish"

      - name: Update version and changelog
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          echo "üì¶ Updating version and changelog..."
          pnpm changeset:version

          # Configure git
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Commit version changes
          git add .
          if git diff --staged --quiet; then
            echo "No version changes to commit"
          else
            git commit -m "chore: version packages [skip ci]"
            git push origin cms
          fi

      - name: Build extension
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          pnpm run clean
          pnpm run compile

      - name: Validate extension integrity
        if: steps.validate-branch.outputs.should_publish == 'true'
        run: |
          # Verify main entry point exists after compilation
          MAIN_FILE=$(node -p "require('./package.json').main")
          if [ ! -f "$MAIN_FILE" ]; then
            echo "Main file $MAIN_FILE does not exist after compilation"
            exit 1
          fi
          echo "Main file exists: $MAIN_FILE"

      - name: Package and Publish to VS Code Marketplace
        if: steps.validate-branch.outputs.should_publish == 'true'
        id: marketplace-publish
        run: |
          echo "üì¶ Packaging extension..."
          pnpm run package

          echo "üöÄ Publishing to VS Code Marketplace..."
          pnpm run publish --pat ${{ secrets.VSCE_PAT }}

          echo "Successfully published to VS Code Marketplace"
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          VSCE_PAT: ${{ secrets.VSCE_PAT }}

      - name: Publish to Open VSX Registry
        if: steps.marketplace-publish.outputs.published == 'true'
        id: openvsx-publish
        continue-on-error: true
        run: |
          echo "üöÄ Publishing to Open VSX Registry..."

          # Install ovsx CLI if not already installed
          if ! command -v ovsx &> /dev/null; then
            echo "Installing ovsx CLI..."
            pnpm add -g ovsx
          fi

          # Publish to Open VSX
          ovsx publish *.vsix -p ${{ secrets.OVSX_PAT }}

          echo "Successfully published to Open VSX Registry"
          echo "published=true" >> $GITHUB_OUTPUT
        env:
          OVSX_PAT: ${{ secrets.OVSX_PAT }}

      - name: Get published version
        if: steps.marketplace-publish.outputs.published == 'true'
        id: version
        run: |
          VERSION=$(node -p "require('./package.json').version")
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Upload VSIX as artifact
        if: steps.marketplace-publish.outputs.published == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: vscode-kubito-${{ steps.version.outputs.version }}
          path: '*.vsix'
          retention-days: 30

      - name: Create GitHub Release
        if: steps.marketplace-publish.outputs.published == 'true'
        run: |
          # Get version from package.json
          VERSION=$(node -p "require('./package.json').version")
          TAG="v$VERSION"

          # Extract changelog for this version
          CHANGELOG=$(awk "/^## $VERSION/,/^## /" CHANGELOG.md | sed '1d;$d')

          # Create release with VSIX file
          gh release create "$TAG" \
            --title "vscode-kubito v$VERSION" \
            --notes "$CHANGELOG" \
            --target cms \
            *.vsix
        env:
          GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN || secrets.GITHUB_TOKEN }}

      - name: Comment on PR
        if: steps.marketplace-publish.outputs.published == 'true'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const bumpType = '${{ steps.detect.outputs.bump_type }}';
            const fs = require('fs');
            const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            const version = packageJson.version;
            const marketplaceLink = `https://marketplace.visualstudio.com/items?itemName=Kubit.vscode-kubito`;
            const openVsxLink = `https://open-vsx.org/extension/Kubit/vscode-kubito`;
            const openVsxPublished = '${{ steps.openvsx-publish.outputs.published }}' === 'true';

            let comment = '## üöÄ Extension Published\n\n';
            comment += `**Version bump type:** \`${bumpType}\`\n\n`;
            comment += '| Platform | Version | Link |\n';
            comment += '|----------|---------|------|\n';
            comment += `| VS Code Marketplace | \`${version}\` | [View on Marketplace](${marketplaceLink}) |\n`;
            if (openVsxPublished) {
              comment += `| Open VSX Registry | \`${version}\` | [View on Open VSX](${openVsxLink}) |\n`;
            }
            comment += '\n### ‚úÖ Published Successfully\n\n';
            comment += '- ‚úÖ VS Code Marketplace\n';
            if (openVsxPublished) {
              comment += '- ‚úÖ Open VSX Registry (for VSCodium, Gitpod, Eclipse Theia)\n';
            } else {
              comment += '- ‚ö†Ô∏è Open VSX Registry (failed - check logs)\n';
            }
            comment += '\n**Installation:**\n';
            comment += '```bash\n';
            comment += 'code --install-extension Kubit.vscode-kubito\n';
            comment += '```';

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Failure notification
        if: failure() && steps.validate-branch.outputs.should_publish == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `## ‚ùå Auto-publish Failed

            The automatic publication process failed. Please check the [workflow logs](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.

            ### üîß Common Solutions
            - **VSCE Token**: Verify VSCE_PAT is valid and has marketplace publish permissions
            - **Release Token**: Add RELEASE_TOKEN secret to bypass branch protection rules
            - **Token Permissions**: Check that tokens have correct permissions
            - **Version Conflict**: Check if version already exists in marketplace
            - **Extension Issues**: Ensure package.json and main file are valid

            ### üîê Required Secrets Configuration
            1. **VSCE_PAT**: 
               - Type: Visual Studio Marketplace Personal Access Token
               - Scope: "Marketplace > Manage" permissions
               - URL: https://dev.azure.com/

            2. **RELEASE_TOKEN** (Required for protected branches):
               - Type: Personal Access Token with bypass permissions
               - Permissions: "Contents: write", "Pull requests: write"
               - Special: "Bypass pull request requirements" if needed

            ### üìû Next Steps
            1. **Marketplace Issues**: Verify VSCE_PAT token and permissions
            2. **Branch Protection**: Add RELEASE_TOKEN secret with bypass permissions
            3. **Logs**: Check error logs for specific authentication issues
            4. **Manual Process**: Use the manual publish workflow if tokens can't be configured`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Skip notification
        if: steps.validate-branch.outputs.should_publish == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const branchName = '${{ github.event.pull_request.head.ref }}';

            const comment = `## ‚ÑπÔ∏è Auto-publish Skipped

            Branch \`${branchName}\` doesn't match required patterns for auto-publishing.

            ### üìã Required Patterns
            | Pattern | Version Bump | Detection Method |
            |---------|--------------|------------------|
            | \`feat/\*\` or \`feature/\*\` | **minor** | Branch prefix or PR title |
            | \`fix/\*\` or \`bugfix/\*\` | **patch** | Branch prefix or default |
            | \`break/\*\` or \`breaking/\*\` | **major** | Branch prefix |
            | \`hotfix/\*\` or \`chore/\*\` | **patch** | Branch prefix |

            ### üéØ Advanced Version Detection
            - **MAJOR**: \`!\` in title, \`[breaking]\` tag, or \`break/\`/\`breaking/\` branch prefix
            - **MINOR**: \`feat:\` or \`feature:\` in PR title, or \`feat/\`/\`feature/\` branch prefix
            - **PATCH**: Default for fixes and other changes

            ### üöÄ To Auto-publish
            Create a new PR from a branch with the appropriate prefix, or use the [manual publish workflow](https://github.com/${{ github.repository }}/actions/workflows/manual-publish.yml).`;

            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
